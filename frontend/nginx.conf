server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html index.htm;

    # Health
    location /health {
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # API: Product Service
    # real routes of product-service are under /api/products and /api/search
    location /api/products/ {
        proxy_pass http://product-service:3000/api/products/;
        proxy_set_header Host $host;
    }
    location /api/search/ {
        proxy_pass http://product-service:3000/api/search/;
        proxy_set_header Host $host;
    }

    location ~ ^/auth/(reset|reset-request|verify)$ {
        try_files $uri /index.html;
    }

    # API: Auth Service
    # If auth-service exposes /auth/... at the root, leave as is;
    # if you mounted it under /api/auth in app.js, adjust to /api/auth/ here.
    location /auth/ {
        proxy_pass http://auth-service:4000/auth/;
        proxy_set_header Host $host;
    }

    # API: Order Service
    location /api/cart/ {
        proxy_pass http://order-service:4001/cart/;
        proxy_set_header Host $host;
    }
    location /api/orders/ {
        proxy_pass http://order-service:4001/orders/;
        proxy_set_header Host $host;
    }

    # Stripe webhook under /api/payments/webhook (recommended)
    location = /api/payments/webhook {
        proxy_pass http://order-service:4001/api/payments/webhook;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Do not alter the body; Express uses raw() on this route
        proxy_set_header Content-Length $content_length;
        proxy_set_header Content-Type $content_type;
    }

    # OPTIONAL: if you have been using /payments/webhook without /api so far, you can keep an alias:
    # location = /payments/webhook { return 307 /api/payments/webhook; }

    # Static
    location /assets/ {
        try_files $uri =404;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }
}